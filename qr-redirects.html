<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Agent Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    /* DASHBOARD THEME */
    :root {
      --bg-page: #f3f4f6;
      --bg-card: #ffffff;
      --border-subtle: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --primary-soft: linear-gradient(135deg, #2563eb, #4f46e5);
      --accent: #f97316;
      --success: #16a34a;
      --danger: #dc2626;
      --radius-card: 16px;
      --radius-pill: 999px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.12);
      --shadow-subtle: 0 8px 20px rgba(15, 23, 42, 0.06);

      /* legacy vars reused with new colors */
      --dialix-orange: var(--primary);
      --dialix-orange-dark: var(--primary-hover);
      --card-bg: rgba(255,255,255,0.98);
      --hover-lift: translateY(-2px);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #e5edff 0, #f3f4f6 40%, #e5e7eb 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
    }

    .app-shell {
      display: flex;
      width: 100%;
      max-width: 1400px;
      margin: 24px auto;
      padding: 0 16px;
      gap: 20px;
    }

    /* SIDEBAR */
    .sidebar {
      width: 260px;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%);
      border-radius: var(--radius-card);
      padding: 18px 16px;
      color: #e5e7eb;
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 10px 4px;
    }

    .brand-logo {
      width: 34px;
      height: 34px;
      border-radius: 14px;
      background: var(--primary-soft);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #f9fafb;
      font-weight: 800;
      font-size: 18px;
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.7);
    }

    .brand-text-title {
      font-weight: 700;
      letter-spacing: 0.08em;
      font-size: 13px;
      text-transform: uppercase;
    }

    .brand-text-sub {
      font-size: 11px;
      color: #9ca3af;
    }

    .sidebar-section-title {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #6b7280;
      padding: 4px 10px;
      margin-top: 4px;
    }

    .nav-list {
      list-style: none;
      padding: 4px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 9px 10px;
      border-radius: 12px;
      color: #e5e7eb;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s ease, transform 0.12s ease, box-shadow 0.2s ease;
    }

    .nav-item:hover {
      background: rgba(148, 163, 184, 0.2);
      transform: translateY(-1px);
    }

    .nav-item.active {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      box-shadow: 0 10px 24px rgba(37, 99, 235, 0.6);
    }

    .nav-item-label { flex: 1; }

    .nav-pill {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      color: #e5e7eb;
    }

    /* MAIN AREA */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .main-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 18px;
      border-radius: var(--radius-card);
      background: rgba(255, 255, 255, 0.9);
      box-shadow: var(--shadow-subtle);
      backdrop-filter: blur(10px);
    }

    .main-header-left {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .main-title {
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 0.04em;
    }

    .main-subtitle {
      font-size: 13px;
      color: var(--text-muted);
    }

    .main-header-actions {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn {
      border: none;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      border-radius: var(--radius-pill);
      padding: 8px 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: background 0.2s ease, transform 0.12s ease, box-shadow 0.2s ease;
      white-space: nowrap;
    }

    .btn-primary {
      color: #f9fafb;
      background-image: var(--primary-soft);
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.55);
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(37, 99, 235, 0.7);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
      border: 1px solid rgba(148, 163, 184, 0.5);
    }

    .btn-ghost:hover {
      background: rgba(243, 244, 246, 0.9);
      transform: translateY(-1px);
    }

    .main-content {
      flex: 1;
      padding: 14px 2px 2px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .card {
      background: var(--bg-card);
      border-radius: var(--radius-card);
      box-shadow: var(--shadow-subtle);
      padding: 18px 18px 16px;
      border: 1px solid var(--border-subtle);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .card-title {
      font-size: 16px;
      font-weight: 600;
    }

    .card-subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .tag-accent {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: var(--radius-pill);
      background: rgba(249, 115, 22, 0.08);
      color: #ea580c;
      border: 1px solid rgba(249, 115, 22, 0.25);
    }

    @media (max-width: 960px) {
      .app-shell { flex-direction: column; }
      .sidebar {
        width: 100%;
        flex-direction: row;
        align-items: center;
        overflow-x: auto;
      }
      .sidebar-section-title { display: none; }
      .nav-list {
        flex-direction: row;
        flex-wrap: wrap;
      }
    }

    /* QR REDIRECT MODULE */
    #appContent {
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 980px;
      background: var(--card-bg);
      padding: 24px 22px 22px;
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, 0.12);
      animation: fadeIn 0.4s ease;
      border: 1px solid rgba(226, 232, 240, 0.9);
    }

    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 18px;
    }

    .logo-group {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo-link img {
      background: #ffffff;
      border:2px solid rgba(148, 163, 184, 0.6);
      padding: 6px;
      height: 40px;
      border-radius:12px;
      transition:0.25s;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.14);
    }
    .logo-link img:hover {
      transform: scale(1.05) translateY(-1px);
      box-shadow: 0 12px 26px rgba(37, 99, 235, 0.35);
      border-color: var(--primary);
    }

    .brand-title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing:0.14em;
    }

    .diali { color: var(--text-main); }
    .x { color: var(--primary); }

    .analytics-btn {
      background: var(--primary-soft);
      color: #f9fafb;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      font-size: 13px;
      display:flex;
      align-items:center;
      gap:6px;
      box-shadow: 0 10px 22px rgba(37, 99, 235, 0.45);
      transition: 0.2s;
    }
    .analytics-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(37, 99, 235, 0.6);
    }

    section.redirect-section {
      margin-top: 18px;
      background:#f9fafb;
      padding:16px 16px 14px;
      border-radius:14px;
      border:1px solid #e5e7eb;
    }

    section.redirect-section h2 {
      margin:0 0 8px 0;
      font-size:15px;
      font-weight:600;
    }

    section.redirect-section p.section-helper {
      margin:0 0 10px 0;
      font-size:12px;
      color:var(--text-muted);
    }

    .redirect-input,
    .redirect-input-small {
      padding: 9px 10px;
      border-radius: 9px;
      border:1px solid #d1d5db;
      font-size: 13px;
      outline:none;
      transition:border-color 0.18s ease, box-shadow 0.18s ease;
      background:#ffffff;
    }

    .redirect-input:focus,
    .redirect-input-small:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 1px rgba(37,99,235,0.16);
    }

    .redirect-input { flex:1; }
    .redirect-input-small {
      width:100%;
      font-size:12px;
    }

    button.success {
      background: var(--primary-soft);
      color:#f9fafb;
      border:none;
      padding:9px 16px;
      font-weight:600;
      border-radius:999px;
      cursor:pointer;
      transition:0.2s;
      font-size:13px;
      box-shadow: 0 10px 20px rgba(37, 99, 235, 0.45);
      white-space:nowrap;
    }
    button.success:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(37, 99, 235, 0.6);
    }

    .saved-check {
      color: var(--success);
      font-weight: 600;
      margin-left: 8px;
      opacity: 0;
      transition: opacity 0.3s;
      font-size: 13px;
    }
    .saved-check.show { opacity: 1; }

    .icon-btn {
      background:#f9fafb;
      border:1px solid #e5e7eb;
      cursor:pointer;
      padding:6px 7px;
      border-radius:8px;
      transition:0.18s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
    }
    .icon-btn:hover {
      background:#eff6ff;
      border-color:#bfdbfe;
      transform:translateY(-1px);
      box-shadow:0 4px 10px rgba(148,163,184,0.4);
    }

    .icon-edit   { color:#2563eb; font-size:18px; }
    .icon-delete { color:#dc2626; font-size:18px; }

    .icon-qr {
      width: 20px;
      height: 20px;
    }

    table {
      width:100%;
      border-collapse: collapse;
      background:white;
      border-radius:12px;
      overflow:hidden;
      box-shadow: 0 6px 18px rgba(148, 163, 184, 0.25);
      font-size:13px;
    }
    th {
      background:linear-gradient(135deg,#eff6ff,#e0f2fe);
      padding:10px;
      font-size:12px;
      text-align:left;
      color:#1f2937;
      border-bottom:1px solid #d1d5db;
    }
    td {
      padding:10px;
      border-top:1px solid #e5e7eb;
      vertical-align: top;
    }

    .copy-btn {
      width: 100%;
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #bfdbfe;
      padding: 6px 0;
      font-size: 12px;
      font-weight: 600;
      border-radius: 999px;
      margin-top: 6px;
      cursor: pointer;
      transition: 0.18s;
    }
    .copy-btn:hover {
      background: #dbeafe;
      transform: translateY(-1px);
      box-shadow:0 3px 10px rgba(191,219,254,0.7);
    }

    /* MODALS */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      backdrop-filter: blur(4px);
    }

    .edit-modal,
    .qr-modal {
      position: relative;
      background: white;
      width: 100%;
      max-width: 420px;
      padding: 24px 22px 22px;
      border-radius: 18px;
      box-shadow: 0 22px 40px rgba(15, 23, 42, 0.45);
      z-index: 1001;
      animation: fadeIn 0.25s ease;
      border:1px solid rgba(226,232,240,0.9);
    }

    .edit-close-x,
    .modal-close-x {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #f3f4f6;
      border: none;
      font-size: 18px;
      border-radius: 999px;
      width: 30px;
      height: 30px;
      cursor: pointer;
      transition: 0.18s;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#4b5563;
    }
    .edit-close-x:hover,
    .modal-close-x:hover {
      background:#e5e7eb;
      transform: var(--hover-lift);
    }

    .qr-modal {
      max-height: 85vh;
      overflow-y: auto;
      padding-top: 48px;
    }

    .close-btn {
      background:#e5e7eb;
      color:#111827;
      border:none;
      padding:8px 16px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      transition:0.18s;
    }
    .close-btn:hover {
      background:#d1d5db;
      transform: var(--hover-lift);
    }

    #qrPreviewModal {
      margin-top: 14px;
      text-align:center;
    }

    #qrCanvas {
      background:#ffffff;
      border-radius:16px;
      box-shadow:0 12px 26px rgba(148,163,184,0.55);
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to   { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- SIDEBAR -->
   <aside class="sidebar">
  <div class="brand">
    <div class="brand-logo">AA</div>
    <div>
      <div class="brand-text-title">AGENT ADMIN</div>
      <div class="brand-text-sub">Home</div> <!-- Change per page: "Smart Signs", "Custom Forms", etc. -->
    </div>
  </div>

  <div class="sidebar-section-title">Sections</div>
  <ul class="nav-list">
    <li class="nav-item" onclick="window.location.href='home.html'">
      <span class="nav-item-label">Home</span>
    </li>
    <li class="nav-item" onclick="window.location.href='smart-signs-dash.html'">
      <span class="nav-item-label">Smart Signs</span>
    </li>
    <li class="nav-item" onclick="window.location.href='qr-redirects.html'">
      <span class="nav-item-label">QR Redirects</span>
    </li>
    <li class="nav-item" onclick="window.location.href='custom-forms-dash.html'">
      <span class="nav-item-label">Custom Forms</span>
    </li>
    <li class="nav-item" onclick="window.location.href='contracts-dash.html'">
      <span class="nav-item-label">Contracts</span>
    </li>
  </ul>
</aside>


    <!-- MAIN -->
    <main class="main">
      <header class="main-header">
        <div class="main-header-left">
          <div class="main-title">QR Redirect Manager</div>
          <div class="main-subtitle">
            Manage short links and QR codes for your listings and marketing.
          </div>
        </div>
        <div class="main-header-actions">
          <button class="btn btn-ghost">Help</button>
          <button class="btn btn-primary" onclick="document.getElementById('newName').focus();">
            New Redirect
          </button>
        </div>
      </header>

      <section class="main-content">
        <div class="card">
          <div class="card-header">
            <div>
              <div class="card-title">Redirects</div>
              <div class="card-subtitle">
                Manage all redirect links and QR codes in one place.
              </div>
            </div>
            <span class="tag-accent">Marketing</span>
          </div>

          <!-- MAIN APP CONTENT -->
          <div id="appContent">
            <div class="top-bar">
              <div class="logo-group">
                <a href="#" class="logo-link">
                  <img src="/assets/logo.png" alt="Logo">
                </a>
                <div class="brand-title">
                  <span class="diali">AGENT</span><span class="x">ADMIN</span> LINKS
                </div>
              </div>

              <a href="analytics.html" class="analytics-btn">
                üìä <span>View Analytics</span>
              </a>
            </div>

            <!-- ADD REDIRECT -->
            <section class="redirect-section">
              <h2>Add Redirect</h2>
              <p class="section-helper">
                Create a friendly link and QR code that forwards visitors to any URL.
              </p>

              <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:center;">
                <input
                  id="newName"
                  class="redirect-input"
                  placeholder="name (ex: rental-mailer)"
                  oninput="validateNameLive(this)"
                  onblur="cleanName(this)"
                />

                <div style="display:flex; flex:2; min-width:220px;">
                  <span style="padding:9px 10px; background:#e5e7eb; border:1px solid #d1d5db; border-right:none; border-radius:999px 0 0 999px; font-size:13px;">
                    https://
                  </span>
                  <input
                    id="newUrlDomain"
                    placeholder="google.com"
                    class="redirect-input"
                    style="border-radius:0 999px 999px 0; border-left:none;"
                  />
                </div>

                <button class="success" onclick="addRedirect()">Add</button>
                <span id="savedCheck" class="saved-check">‚úî Saved</span>
              </div>
            </section>

            <!-- EXISTING REDIRECTS -->
            <section class="redirect-section">
              <h2>Existing Redirects</h2>
              <p class="section-helper">
                Copy, edit, or delete existing links. Generate QR codes or view analytics.
              </p>

              <table id="redirectTable">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Destination</th>
                    <th>Final Link</th>
                    <th style="width:170px;">Actions</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </section>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- EDIT MODAL -->
  <div id="editModalBackdrop" class="modal-backdrop">
    <div class="edit-modal">
      <button class="edit-close-x" onclick="closeEditModal()">‚úï</button>
      <h3 style="margin-bottom:10px;">Edit Redirect</h3>

      <label style="font-size:13px; color:#4b5563;">Name</label>
      <input id="editName" readonly style="width:100%; margin-bottom:10px; padding:9px 10px; border-radius:9px; border:1px solid #d1d5db;">

      <label style="font-size:13px; color:#4b5563;">Destination URL</label>
      <input id="editUrl" style="width:100%; margin-bottom:10px; padding:9px 10px; border-radius:9px; border:1px solid #d1d5db;">

      <label style="font-size:13px; color:#4b5563;">Final URL</label>
      <input id="editFinalUrl" readonly style="width:100%; margin-bottom:16px; padding:9px 10px; border-radius:9px; border:1px solid #e5e7eb; background:#f9fafb; font-size:12px;">

      <button class="success" onclick="saveEdit()" style="width:100%;">Save</button>
    </div>
  </div>

  <!-- QR MODAL -->
  <div id="qrModalBackdrop" class="modal-backdrop">
    <div class="qr-modal">
      <button class="modal-close-x" onclick="closeQrModal()">‚úï</button>
      <h3 style="margin-bottom:12px;">Generate QR Code</h3>

      <label style="font-size:13px; color:#4b5563;">Name</label>
      <input id="qrName" style="width:100%; margin-bottom:10px; padding:9px 10px; border-radius:9px; border:1px solid #d1d5db;" readonly>

      <label style="font-size:13px; color:#4b5563;">Final URL</label>
      <input id="qrShareUrl" style="width:100%; margin-bottom:10px; padding:9px 10px; border-radius:9px; border:1px solid #e5e7eb; background:#f9fafb; font-size:12px;" readonly>

      <label style="font-size:13px; color:#4b5563;">Style</label>
      <select id="qrStyle" style="width:100%; margin-bottom:10px; padding:9px 10px; border-radius:9px; border:1px solid #d1d5db;">
        <option value="square">Standard Square</option>
        <option value="rounded">Rounded Frame</option>
        <option value="circle">Circle Frame</option>
        <option value="border">Thick Border</option>
      </select>

      <label style="font-size:13px; color:#4b5563;">Size</label>
      <select id="qrSize" style="width:100%; margin-bottom:10px; padding:9px 10px; border-radius:9px; border:1px solid #d1d5db;">
        <option value="200">Small (200px)</option>
        <option value="260" selected>Medium (260px)</option>
        <option value="360">Large (360px)</option>
      </select>

      <button class="success" onclick="generateQR()" style="width:100%;">Generate</button>

      <div id="qrPreviewModal" style="display:none;">
        <canvas id="qrCanvas"></canvas>
        <div style="margin-top:15px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap;">
          <button class="success" onclick="downloadPNG()">PNG</button>
          <button class="close-btn" onclick="downloadSVG()">SVG</button>
        </div>
      </div>

      <button class="close-btn" style="width:100%; margin-top:18px;" onclick="closeQrModal()">Close</button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
<script>
  const base = "/.netlify/functions";
  let redirectNames = [];
  let lastSvg = null;
  const TEMP_PIN = "admin";

  window.addEventListener("load", () => {
    loadRedirects();
  });

  function validateNameLive(i) { i.value = i.value.toLowerCase().replace(/[^a-z0-9-]/g, ""); }
  function cleanName(i) { i.value = i.value.trim().toLowerCase().replace(/[^a-z0-9-]/g, ""); }
  function makeShareUrl(n) { return window.location.origin + "/qr/" + n; }

  // üî• FIXED loadRedirects - USES REAL DATA
  async function loadRedirects() {
  console.log('üöÄ QR TABLE - REAL DATA MODE');
  
  redirectNames = [];  // üî• ALWAYS CLEAR FIRST
  
  try {
    const pin = TEMP_PIN;
    const res = await fetch(`${base}/getredirects?pin=${encodeURIComponent(pin)}`);
    const data = await res.json();
    
    const redirects = Array.isArray(data.redirects) ? data.redirects : Array.from(data.redirects || []);
    redirectNames = redirects.map(x => x.name);  // Rebuild after data
      
      const table = document.querySelector("#redirectTable tbody");
      table.innerHTML = "";
      
      redirects.forEach(item => {
        const share = makeShareUrl(item.name);
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${item.name}</td>
          <td>${item.url}</td>
          <td>
            <input value="${share}" readonly class="redirect-input-small">
            <button class="copy-btn" onclick="navigator.clipboard.writeText('${makeShareUrl(item.name)}'); alert('Copied!')">Copy</button>
          </td>
          <td style="display:flex; gap:6px; flex-wrap:wrap;">
            <button class="icon-btn" title="Generate QR" onclick="openQrFor('${item.name}')">
              <svg class="icon-qr" viewBox="0 0 24 24" fill="black">
                <path d="M3 3h8v8H3V3zm2 2v4h4V5H5zm6 6h8v8h-8v-8zm2 2v4h4v-4h-4zM3 13h8v8H3v-8zm2 2v4h4v-4H5zm12-12h4v4h-4V3zm0 6h4v2h-4V9zm0 4h2v2h-2v-2zm2 2h2v4h-2v-4zm-2 4h2v2h-2v-2z"/>
              </svg>
            </button>
            <button class="icon-btn icon-edit" title="Edit" onclick="openEditModal('${item.name}','${item.url}')">‚úèÔ∏è</button>
            <button class="icon-btn icon-delete" title="Delete" onclick="deleteRedirect('${item.name}')">üóëÔ∏è</button>
            <button class="icon-btn" title="Per-Link Analytics" onclick="window.location.href='/analytics-name.html?name=${item.name}'">üìä</button>
          </td>
        `;
        table.appendChild(row);
      });
      console.log('‚úÖ TABLE RENDERED:', redirects.length, 'rows');
    } catch (error) {
      console.error('Load failed:', error);
      // Fallback to hardcoded if backend fails
      console.log('üî• FALLBACK TO HARDCODE');
      const redirects = [{name: 'testtest', url: 'https://nfl.com'}, {name: 'demo', url: 'https://google.com'}];
      // ... rest of table render code
    }
  }

  function copyUrl(url) {
    navigator.clipboard.writeText(url);
    alert("Copied: " + url);
  }

  async function addRedirect() {
    const pin = TEMP_PIN;
    const name = document.getElementById("newName").value.trim();
    let dom = document.getElementById("newUrlDomain").value.trim();

    if (!name || !dom) return alert("Missing fields");
    if (redirectNames.includes(name)) return alert("Name already exists");

    dom = dom.replace(/^https?:\/\//, "");
    const url = "https://" + dom;

    await fetch(`${base}/updateredirects?pin=${encodeURIComponent(pin)}&mode=add&name=${encodeURIComponent(name)}&url=${encodeURIComponent(url)}`);

    document.getElementById("newName").value = "";
    document.getElementById("newUrlDomain").value = "";
    
    const saved = document.getElementById("savedCheck");
    saved.classList.add("show");
    setTimeout(() => saved.classList.remove("show"), 1400);

    redirectNames = []; 
    loadRedirects(); // Refresh table
  }

  // üî• FIXED DELETE
  async function deleteRedirect(name) {
    if (!confirm(`Delete "${name}"?`)) return;
    const pin = TEMP_PIN;
    await fetch(`${base}/updateredirects?pin=${encodeURIComponent(pin)}&mode=remove&name=${encodeURIComponent(name)}`);
    loadRedirects();
  }

  // üî• FIXED EDIT
  function openEditModal(name, url) {
    document.getElementById("editName").value = name;
    document.getElementById("editUrl").value = url;
    document.getElementById("editFinalUrl").value = makeShareUrl(name);
    document.getElementById("editModalBackdrop").style.display = "flex";
  }

  function closeEditModal() {
    document.getElementById("editModalBackdrop").style.display = "none";
  }

 async function saveEdit() {
  const pin = TEMP_PIN;
  const name = document.getElementById("editName").value.trim();
  const url = document.getElementById("editUrl").value.trim();

  if (!url) return alert("URL cannot be empty");

  try {
    await fetch(`${base}/updateredirects?pin=${encodeURIComponent(pin)}&mode=edit&name=${encodeURIComponent(name)}&url=${encodeURIComponent(url)}`);
    
    closeEditModal();
    
    // üî• KILL CACHE + FORCE RELOAD
    redirectNames = [];  // Clear cache
    
    // Double-load forces fresh data
    await loadRedirects();
    await loadRedirects(); // Second call uses fresh redirectNames
    
    console.log('‚úÖ Edit + double refresh complete');
    
  } catch (error) {
    alert('Edit failed: ' + error.message);
  }
}



  // üî• QR FUNCTIONS (unchanged - already working)
  function openQrFor(name) {
    document.getElementById("qrName").value = name;
    document.getElementById("qrShareUrl").value = makeShareUrl(name);
    document.getElementById("qrPreviewModal").style.display = "none";
    document.getElementById("qrModalBackdrop").style.display = "flex";
  }

  function closeQrModal() {
    document.getElementById("qrModalBackdrop").style.display = "none";
  }

  function generateQR() {
    const name = document.getElementById("qrName").value;
    const url = makeShareUrl(name);
    const size = parseInt(document.getElementById("qrSize").value);

    const inner = size - 40;
    const tmp = document.createElement("canvas");
    tmp.width = inner; tmp.height = inner;

    new QRious({ element: tmp, value: url, size: inner, level: "H" });
    const qrData = tmp.toDataURL("image/png");

    lastSvg = buildFrameSVG(document.getElementById("qrStyle").value, size, qrData);

    const img = new Image();
    img.onload = () => {
      const c = document.getElementById("qrCanvas");
      c.width = size; c.height = size;
      c.getContext("2d").drawImage(img, 0, 0, size, size);
    };
    img.src = "data:image/svg+xml;base64," + btoa(lastSvg);

    document.getElementById("qrPreviewModal").style.display = "block";
  }

  function buildFrameSVG(style, size, data) {
    const margin = 20;
    const inner = size - margin * 2;
    const half = size / 2;
    let frame = "";

    if (style === "rounded")
      frame = `<rect x="3" y="3" width="${size - 6}" height="${size - 6}" rx="18" stroke="black" fill="none" stroke-width="3"/>`;
    else if (style === "circle")
      frame = `<circle cx="${half}" cy="${half}" r="${half - 15}" stroke="black" fill="none" stroke-width="3"/>`;
    else if (style === "border")
      frame = `<rect x="3" y="3" width="${size - 6}" height="${size - 6}" stroke="black" fill="none" stroke-width="5"/>`;

    return `
      <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}">
        ${frame}
        <image href="${data}" x="20" y="20" width="${inner}" height="${inner}"/>
      </svg>
    `;
  }

  function downloadPNG() {
    if (!lastSvg) return;
    const size = parseInt(document.getElementById("qrSize").value);
    const img = new Image();

    img.onload = () => {
      const c = document.createElement("canvas");
      c.width = size; c.height = size;
      c.getContext("2d").drawImage(img, 0, 0, size, size);

      const a = document.createElement("a");
      a.download = "qr.png";
      a.href = c.toDataURL("image/png");
      a.click();
    };
    img.src = "data:image/svg+xml;base64," + btoa(lastSvg);
  }

  function downloadSVG() {
    if (!lastSvg) return;
    const blob = new Blob([lastSvg], { type: "image/svg+xml" });
    const a = document.createElement("a");
    a.download = "qr.svg";
    a.href = URL.createObjectURL(blob);
    a.click();
  }
</script>


</body>
</html>
